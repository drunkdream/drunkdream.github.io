<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="referrer" content="no-referrer-when-downgrade">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css">


  <meta name="keywords" content="binfmts,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1">






<meta name="description" content="0x00 什么是binfmt-miscbinfmt-misc(Miscellaneous Binary Format)是Linux内核提供的一种类似Windows上文件关联的功能，但比文件关联更强大的是，它不仅可以根据文件后缀名判断，还可以根据文件内容(Magic Bytes)使用不同的程序打开。一个典型的使用场景就是：使用qemu运行其它架构平台上的二进制文件。 本文以该场景为例，分析一下其具体">
<meta name="keywords" content="binfmts">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux中的binfmt-misc原理分析">
<meta property="og:url" content="https://www.drunkdream.com/2024/02/07/linux-binfmts/index.html">
<meta property="og:site_name" content="醉梦轩">
<meta property="og:description" content="0x00 什么是binfmt-miscbinfmt-misc(Miscellaneous Binary Format)是Linux内核提供的一种类似Windows上文件关联的功能，但比文件关联更强大的是，它不仅可以根据文件后缀名判断，还可以根据文件内容(Magic Bytes)使用不同的程序打开。一个典型的使用场景就是：使用qemu运行其它架构平台上的二进制文件。 本文以该场景为例，分析一下其具体">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2024-05-16T15:42:44.537Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux中的binfmt-misc原理分析">
<meta name="twitter:description" content="0x00 什么是binfmt-miscbinfmt-misc(Miscellaneous Binary Format)是Linux内核提供的一种类似Windows上文件关联的功能，但比文件关联更强大的是，它不仅可以根据文件后缀名判断，还可以根据文件内容(Magic Bytes)使用不同的程序打开。一个典型的使用场景就是：使用qemu运行其它架构平台上的二进制文件。 本文以该场景为例，分析一下其具体">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":0,"b2t":true,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://www.drunkdream.com/2024/02/07/linux-binfmts/">





  <title>Linux中的binfmt-misc原理分析 | 醉梦轩</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?6b044934808dac49251aa0a35cf37875";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>











  
  
    
  

  <div class="container sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">醉梦轩</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">醉中无日月，梦里有乾坤</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://www.drunkdream.com/2024/02/07/linux-binfmts/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="drunkdream">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/logo.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="醉梦轩">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Linux中的binfmt-misc原理分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2024-02-07T14:13:37+00:00">
                2024-02-07
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  2.3k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  10
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="0x00-什么是binfmt-misc"><a href="#0x00-什么是binfmt-misc" class="headerlink" title="0x00 什么是binfmt-misc"></a>0x00 什么是binfmt-misc</h2><p>binfmt-misc(Miscellaneous Binary Format)是Linux内核提供的一种类似Windows上文件关联的功能，但比文件关联更强大的是，它不仅可以根据文件后缀名判断，还可以根据文件内容(Magic Bytes)使用不同的程序打开。一个典型的使用场景就是：使用<code>qemu</code>运行其它架构平台上的二进制文件。</p>
<p>本文以该场景为例，分析一下其具体的工作原理。</p>
<h2 id="0x01-开启binfmt-misc"><a href="#0x01-开启binfmt-misc" class="headerlink" title="0x01 开启binfmt-misc"></a>0x01 开启binfmt-misc</h2><p>临时开启可以使用以下命令：</p>
<pre><code class="bash">$ sudo mount binfmt_misc -t binfmt_misc /proc/sys/fs/binfmt_misc
</code></pre>
<p>这种方式重启后会失效，如果想长期生效，可以在<code>/etc/fstab</code>文件中增加一行：</p>
<pre><code>none  /proc/sys/fs/binfmt_misc binfmt_misc defaults 0 0
</code></pre><p>可以使用以下命令检查开启是否成功：</p>
<pre><code class="bash">$ mount | grep binfmt_misc
binfmt_misc on /proc/sys/fs/binfmt_misc type binfmt_misc (rw,relatime)
$ ls -l /proc/sys/fs/binfmt_misc
总用量 0
--w------- 1 root root 0 2月   5 22:55 register
-rw-r--r-- 1 root root 0 2月   5 22:55 status
</code></pre>
<h2 id="0x02-在x86-64系统中运行arm64应用"><a href="#0x02-在x86-64系统中运行arm64应用" class="headerlink" title="0x02 在x86_64系统中运行arm64应用"></a>0x02 在x86_64系统中运行arm64应用</h2><p>先准备一个arm64架构的程序(可以使用go跨平台编译生成一个)，执行后发现有报错：</p>
<pre><code>bash: ./go-test：无法执行二进制文件: 可执行文件格式错误
</code></pre><p>现在，我们执行一下<code>apt install qemu-user-binfmt</code>命令，然后再运行上面的arm64程序，发现能正常运行了。安装<code>qemu-user-binfmt</code>后，会在<code>/proc/sys/fs/binfmt_misc</code>目录下创建若干个文件，其中就有一个<code>qemu-aarch64</code>。来看一下这个文件的内容：</p>
<pre><code class="bash">$ cat /proc/sys/fs/binfmt_misc/qemu-aarch64
enabled
interpreter /usr/libexec/qemu-binfmt/aarch64-binfmt-P
flags: POC
offset 0
magic 7f454c460201010000000000000000000200b700
mask ffffffffffffff00fffffffffffffffffeffffff
</code></pre>
<p>这个文件描述的是规则文件，第一行<code>enabled</code>表示该规则启用；第二行<code>interpreter /usr/libexec/qemu-binfmt/aarch64-binfmt-P</code>表示使用<code>/usr/libexec/qemu-binfmt/aarch64-binfmt-P</code>来执行二进制文件；第三行<code>flags: POC</code>表示运行的标志位，具体含义如下：</p>
<ul>
<li><code>P</code>: 表示perserve-argv，这意味着在调用模拟器时，原始的参数（argv）将被保留。这对于某些程序在运行时需要知道它们自己的名称（即argv[0]）的情况很有用</li>
<li><code>O</code>: 表示offset，这意味着在启动模拟器之前，需要从二进制文件中读取一个偏移量。这个偏移量将作为模拟器的一个参数</li>
<li><code>C</code>: 表示credentials，这意味着模拟器将使用与原始程序相同的用户ID和组ID运行。这有助于确保模拟器在运行时具有与原始程序相同的权限</li>
</ul>
<p>第四行<code>offset 0</code>表示从<code>0</code>偏移值开始读取文件；第五行<code>magic 7f454c460201010000000000000000000200b700</code>表示要匹配的魔术字节；<code>mask ffffffffffffff00fffffffffffffffffeffffff</code>表示字节掩码，用来忽略掉文件中的一些不重要的字节。</p>
<p>可以看出，这条规则会使用<code>/usr/libexec/qemu-binfmt/aarch64-binfmt-P</code>来执行arm64架构的二进制文件，而这个文件其实是一个软链，实际指向的是：<code>/usr/bin/qemu-aarch64</code>。</p>
<h2 id="0x03-手动创建执行规则"><a href="#0x03-手动创建执行规则" class="headerlink" title="0x03 手动创建执行规则"></a>0x03 手动创建执行规则</h2><p>在上面的例子中，<code>/proc/sys/fs/binfmt_misc/qemu-aarch64</code>文件是在安装qemu库的时候自动安装进去的。如果想手动创建一条规则，该怎么操作呢？</p>
<p>我们先将以下代码保存到文件<code>main.go</code>中：</p>
<pre><code class="go">package main

import (
    &quot;fmt&quot;
    &quot;os&quot;
)

func main() {
    fmt.Println(&quot;Program name:&quot;, os.Args[0])

    if len(os.Args) &gt; 1 {
        fmt.Println(&quot;Arguments:&quot;)
        for i, arg := range os.Args[1:] {
            fmt.Printf(&quot;Arg %d: %s\n&quot;, i+1, arg)
        }
    } else {
        fmt.Println(&quot;No arguments provided.&quot;)
    }
}
</code></pre>
<p>使用命令：<code>go build -o fake-runner ./main.go</code>进行编译，并将编译出来的<code>fake-runner</code>拷贝到<code>/usr/local/bin</code>目录下。</p>
<p>此时，我们需要向<code>/proc/sys/fs/binfmt_misc/register</code>中按照<code>:name:type:offset:magic:mask:interpreter:flags</code>的格式写入规则。</p>
<ul>
<li>name: 规则名</li>
<li>type: 类型，取<code>E</code>(按扩展名匹配)或<code>M</code>(按文件魔术字节匹配)之一</li>
<li>offset: 当<code>type</code>为<code>M</code>时生效，表示魔术字节的偏移值</li>
<li>magic: 当<code>type</code>为<code>E</code>时，表示要匹配的后缀名；当<code>type</code>为<code>M</code>时，表示16进制的魔术字节</li>
<li>mask: 当<code>type</code>为<code>M</code>时生效，表示魔术字节的掩码，与IP地址掩码类似</li>
<li>interpreter: 解释器文件的绝对路径</li>
<li>flags: 含义与上面的<code>flags</code>一致</li>
</ul>
<p>假设我们想用<code>fake-runner</code>打开以<code>12344578</code>开头的文件，可以执行以下命令：</p>
<pre><code class="bash"># echo &#39;:binfmt-test:M::12345678::/usr/local/bin/fake-runner:P&#39; &gt; /proc/sys/fs/binfmt_misc/register
# cat /proc/sys/fs/binfmt_misc/binfmt-test enabled
interpreter /usr/local/bin/fake-runner
flags: P
offset 0
magic 3132333435363738
</code></pre>
<p>此命令需要在root权限下运行。</p>
<p>然后使用命令生成目标文件：</p>
<pre><code class="bash">$ echo 12345678 &gt; /tmp/test.txt
$ chmod 755 /tmp/test.txt
$ /tmp/test.txt hello
Program name: /usr/local/bin/fake-runner
Arguments:
Arg 1: /tmp/test.txt
Arg 2: /tmp/test.txt
Arg 3: hello
</code></pre>
<p>删除规则可以使用命令：<code>echo -1 &gt; /proc/sys/fs/binfmt_misc/binfmt-test</code></p>
<h2 id="0x04-在x86-64系统中运行arm64架构的Docker镜像"><a href="#0x04-在x86-64系统中运行arm64架构的Docker镜像" class="headerlink" title="0x04 在x86_64系统中运行arm64架构的Docker镜像"></a>0x04 在x86_64系统中运行arm64架构的Docker镜像</h2><p>现在我们用docker命令运行一个arm64的镜像：</p>
<pre><code class="bash">$ docker run -it arm64v8/ubuntu bash
Unable to find image &#39;arm64v8/ubuntu:latest&#39; locally
latest: Pulling from arm64v8/ubuntu
005e2837585d: Pull complete 
Digest: sha256:ba545858745d6307f0d1064d0d25365466f78d02f866cf4efb9e1326a4c196ca
Status: Downloaded newer image for arm64v8/ubuntu:latest
standard_init_linux.go:207: exec user process caused &quot;no such file or directory&quot;
</code></pre>
<p>通过一番探索之后，发现只要执行下命令：<code>apt install qemu-user-static</code>，再启动docker容器就正常了。执行这条命令会修改<code>/usr/libexec/qemu-binfmt/aarch64-binfmt-P</code>文件的软链到<code>/usr/bin/qemu-aarch64-static</code>。我们来看下<code>qemu-aarch64</code>和<code>qemu-aarch64-static</code>区别：</p>
<pre><code class="bash">$ readelf -d /usr/bin/qemu-aarch64
Dynamic section at offset 0x3aee38 contains 37 entries:
  标记        类型                         名称/值
 0x0000000000000001 (NEEDED)             共享库：[libz.so.1]
 0x0000000000000001 (NEEDED)             共享库：[librt.so.1]
 0x0000000000000001 (NEEDED)             共享库：[libcapstone.so.4]
 0x0000000000000001 (NEEDED)             共享库：[libglib-2.0.so.0]
 0x0000000000000001 (NEEDED)             共享库：[libgnutls.so.30]
 0x0000000000000001 (NEEDED)             共享库：[libgmodule-2.0.so.0]
 0x0000000000000001 (NEEDED)             共享库：[libstdc++.so.6]
 0x0000000000000001 (NEEDED)             共享库：[libm.so.6]
 0x0000000000000001 (NEEDED)             共享库：[libgcc_s.so.1]
 0x0000000000000001 (NEEDED)             共享库：[libpthread.so.0]
 0x0000000000000001 (NEEDED)             共享库：[libc.so.6]
 0x000000000000000c (INIT)               0xab000
 0x000000000000000d (FINI)               0x2a83ec
 0x0000000000000019 (INIT_ARRAY)         0x35b8e0
 0x000000000000001b (INIT_ARRAYSZ)       248 (bytes)
 0x000000000000001a (FINI_ARRAY)         0x35b9d8
 0x000000000000001c (FINI_ARRAYSZ)       8 (bytes)
 0x000000006ffffef5 (GNU_HASH)           0x340
 0x0000000000000005 (STRTAB)             0x2a608
 0x0000000000000006 (SYMTAB)             0xa1f0
 0x000000000000000a (STRSZ)              122726 (bytes)
 0x000000000000000b (SYMENT)             24 (bytes)
 0x0000000000000015 (DEBUG)              0x0
 0x0000000000000003 (PLTGOT)             0x3b00c8
 0x0000000000000002 (PLTRELSZ)           11136 (bytes)
 0x0000000000000014 (PLTREL)             RELA
 0x0000000000000017 (JMPREL)             0xa7f68
 0x0000000000000007 (RELA)               0x4b2e0
 0x0000000000000008 (RELASZ)             380040 (bytes)
 0x0000000000000009 (RELAENT)            24 (bytes)
 0x000000000000001e (FLAGS)              BIND_NOW
 0x000000006ffffffb (FLAGS_1)            标志： NOW PIE
 0x000000006ffffffe (VERNEED)            0x4b070
 0x000000006fffffff (VERNEEDNUM)         7
 0x000000006ffffff0 (VERSYM)             0x4856e
 0x000000006ffffff9 (RELACOUNT)          15807
 0x0000000000000000 (NULL)               0x0

$ readelf -d /usr/bin/qemu-aarch64-static
There is no dynamic section in this file.
</code></pre>
<p>可以看出，qemu-aarch64-static是没有动态库依赖的，也就是说，docker必须使用静态编译的<code>qemu</code>才能工作。通过这种方式，可以实现在x86_64机器上编译跨架构镜像的目的。</p>
<h2 id="0x05-跨架构编译Docker镜像"><a href="#0x05-跨架构编译Docker镜像" class="headerlink" title="0x05 跨架构编译Docker镜像"></a>0x05 跨架构编译Docker镜像</h2><p>要支持多架构，需要开启Docker的实验功能，开启方式如下：</p>
<p>在文件<code>/etc/docker/daemon.json</code>中添加如下配置</p>
<pre><code class="json">{
    &quot;experimental&quot;: true
}
</code></pre>
<p>然后使用<code>sysemcrtl restart docker</code>命令重启Docker服务。</p>
<pre><code class="bash">$ docker info | grep -i &#39;experimental&#39;
 Experimental: true
</code></pre>
<p>当看到以上输出时，就表示实验功能已开启。</p>
<p>编写以下Dockerfile:</p>
<pre><code class="Dockerfile">FROM ubuntu:20.04

RUN set -ex &amp;&amp; apt update
</code></pre>
<p>然后使用以下命令编译arm64镜像</p>
<pre><code class="bash">$ sudo docker build --platform linux/arm64 -t ubuntu .
$ sudo docker run -it ubuntu bash
root@616a3dd3a915:/# uname -a
Linux 616a3dd3a915 5.15.34-amd64-desktop #2 SMP Mon May 16 16:31:30 CST 2022 aarch64 aarch64 aarch64 GNU/Linux
</code></pre>
<p>因此，使用<code>--platform linux/arm64</code>参数就可以编译出arm64架构的镜像。</p>
<h2 id="0x06-在Linux上运行Windows可执行文件"><a href="#0x06-在Linux上运行Windows可执行文件" class="headerlink" title="0x06 在Linux上运行Windows可执行文件"></a>0x06 在Linux上运行Windows可执行文件</h2><p>使用<code>binfmt-misc</code>机制可以支持直接在Linux上运行Windows的exe文件，这是通过wine来实现的。</p>
<pre><code class="bash">$ cat /proc/sys/fs/binfmt_misc/DOSWin
enabled
interpreter /usr/bin/wine
flags: 
offset 0
magic 4d5a
$ ls -l /usr/bin/wine
lrwxrwxrwx 1 root root 19 10月  8 18:09 /usr/bin/wine -&gt; deepin-wine6-stable
</code></pre>
<p>deepin-wine6-stable其实是一个bash脚本：</p>
<pre><code class="bash">#!/bin/bash

name=${0##*/}
bindir=/usr/lib/$name

wine32=/opt/$name/bin/wine
wine64=/opt/$name/bin/wine64

if test -x $wine32 -a &quot;$WINEARCH&quot; != &quot;win64&quot;; then
    wine=$wine32
elif test -x $wine64; then
    wine=$wine64
    if [ &quot;$(dpkg --print-architecture)&quot; = &quot;amd64&quot; -a &quot;$(dpkg --print-foreign-architectures | grep -cx &quot;i386&quot;)&quot; -ne 1 ]; then
        echo &quot;it looks like multiarch needs to be enabled.  as root, please&quot;
        echo &quot;execute \&quot;dpkg --add-architecture i386 &amp;&amp; apt-get update &amp;&amp;&quot;
        echo &quot;apt-get install $(echo $name | sed s/wine/wine32/)\&quot;&quot;
    fi
else
    echo &quot;error: unable to find wine executable.  this shouldn&#39;t happen.&quot;
    exit 1
fi

if test -z &quot;$WINEPREFIX&quot;; then
    if test &quot;$wine&quot; = &quot;$wine64&quot;; then
        wineprefix=$HOME/.wine64
    else
        wineprefix=$HOME/.wine
    fi
else
    wineprefix=$WINEPREFIX
fi

if test -z &quot;$WINELOADER&quot;; then
    wineloader=$wine
else
    wineloader=$WINELOADER
fi

if test -z &quot;$WINEDEBUG&quot;; then
    winedebug=-all
else
    winedebug=$WINEDEBUG
fi

runtime_path=/opt/deepinwine/runtime-i386

export LD_LIBRARY_PATH=&quot;/opt/$name/lib:/opt/$name/lib64:$LD_LIBRARY_PATH&quot;
export WINEDLLPATH=/opt/$name/lib:/opt/$name/lib64

# 32位wine需要指定32位runtime的路径
if [ -f &quot;$runtime_path/init_runtime.sh&quot; -a &quot;$wine&quot; = &quot;$wine32&quot; ];then
    source &quot;$runtime_path/init_runtime.sh&quot;

    PE_FILE=&quot;$1&quot;
    if [[ &quot;$1&quot; == *&quot;.exe&quot; ]]; then
        PE_FILE=${PE_FILE//\\/\/}
        drive=${PE_FILE:0:2}
        if [[ ${drive} == &quot;c:&quot;* || ${drive} == &quot;C:&quot;* ]]; then
            PE_FILE=${wineprefix}/drive_c${PE_FILE:2}
        fi
    fi

    init_runtime
    if [ -f &quot;$PE_FILE&quot; ];then
        #only 32 bit application need config this envs
        if file &quot;$PE_FILE&quot; | grep -q -e &quot;PE32 &quot;; then
            init_32bit_config
        fi
    fi
    export WINELOADERNOEXEC=1
    winepreloader=/opt/$name/bin/wine-preloader
    WINEPREFIX=$wineprefix WINELOADER=$wineloader WINEDEBUG=$winedebug $winepreloader $wine &quot;$@&quot;
else
    WINEPREFIX=$wineprefix WINELOADER=$wineloader WINEDEBUG=$winedebug $wine &quot;$@&quot;
fi
</code></pre>
<p>因此，直接在命令行中输入一个exe文件路径，例如扫雷游戏，就会看到系统打开了扫雷游戏界面。</p>
<h2 id="0x07-总结"><a href="#0x07-总结" class="headerlink" title="0x07 总结"></a>0x07 总结</h2><p>binfmt-misc提供了灵活的文件关联机制，使得部分无法直接执行的程序可以像普通Linux程序一样直接运行起来（如：跨架构程序、Windows exe等）。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>本文作者：</strong>
      drunkdream
    </li>
    <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://www.drunkdream.com/2024/02/07/linux-binfmts/" title="Linux中的binfmt-misc原理分析">https://www.drunkdream.com/2024/02/07/linux-binfmts/</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明： </strong>
      本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
    </li>
  </ul>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/binfmts/" rel="tag"># binfmts</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2024/01/05/ipad-install-linux/" rel="next" title="iPad上使用UTM安装Linux arm64系统">
                <i class="fa fa-chevron-left"></i> iPad上使用UTM安装Linux arm64系统
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2024/03/06/scratch-clock/" rel="prev" title="Scratch教程---开发一个时钟">
                Scratch教程---开发一个时钟 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        
<div class="-mob-share-ui-button -mob-share-open">分享</div>
<div class="-mob-share-ui" style="display: none">
    <ul class="-mob-share-list">
        <li class="-mob-share-weibo"><p>新浪微博</p></li>
        <li class="-mob-share-tencentweibo"><p>腾讯微博</p></li>
        <li class="-mob-share-qzone"><p>QQ空间</p></li>
        <li class="-mob-share-qq"><p>QQ好友</p></li>
        <li class="-mob-share-renren"><p>人人网</p></li>
        <li class="-mob-share-kaixin"><p>开心网</p></li>
        <li class="-mob-share-douban"><p>豆瓣</p></li>
        <li class="-mob-share-facebook"><p>Facebook</p></li>
        <li class="-mob-share-twitter"><p>Twitter</p></li>
    </ul>
    <div class="-mob-share-close">取消</div>
</div>
<div class="-mob-share-ui-bg"></div>
<script id="-mob-share" src="//f1.webshare.mob.com/code/mob-share.js?appkey=1e64ff5cae2be"></script>

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
      <div id="gitalk-container"></div>
      <script src="https://unpkg.com/gitalk@1.5.0/dist/gitalk.min.js"></script>
      <script type="text/javascript">
          var gitalk = new Gitalk({
              clientID: 'Iv1.bbffb0360439c133',
              clientSecret: '6c02cd39741abd9ceae5cf5a8fdf5cbc0d5d4eda',
              id: window.location.pathname,
              repo: 'drunkdream.github.io',
              owner: 'drunkdream',
              admin: 'drunkdream',
              proxy: '/github/login/oauth/access_token'
          })
          gitalk.render('gitalk-container')
      </script>
      <style>
          .gt-container a {
              border: none;
          }
          .gt-container .gt-header-controls-tip {
              font-size: 12px;
              position: relative;
              top: -10px;
          }
      </style>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/logo.gif" alt="drunkdream">
          <p class="site-author-name" itemprop="name">drunkdream</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">83</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">69</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x00-什么是binfmt-misc"><span class="nav-number">1.</span> <span class="nav-text">0x00 什么是binfmt-misc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-开启binfmt-misc"><span class="nav-number">2.</span> <span class="nav-text">0x01 开启binfmt-misc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-在x86-64系统中运行arm64应用"><span class="nav-number">3.</span> <span class="nav-text">0x02 在x86_64系统中运行arm64应用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-手动创建执行规则"><span class="nav-number">4.</span> <span class="nav-text">0x03 手动创建执行规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-在x86-64系统中运行arm64架构的Docker镜像"><span class="nav-number">5.</span> <span class="nav-text">0x04 在x86_64系统中运行arm64架构的Docker镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05-跨架构编译Docker镜像"><span class="nav-number">6.</span> <span class="nav-text">0x05 跨架构编译Docker镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x06-在Linux上运行Windows可执行文件"><span class="nav-number">7.</span> <span class="nav-text">0x06 在Linux上运行Windows可执行文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x07-总结"><span class="nav-number">8.</span> <span class="nav-text">0x07 总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2017 - 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">drunkdream</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>


        
      </div>
    </footer>

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (search_path.endsWith("json")) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('-1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  
<link rel="stylesheet" href="/lib/prettify/skins/solarized-dark.css" type="text/css">
<script src="/lib/prettify/prettify.js" type="text/javascript"></script>
<script type="text/javascript">
  $(document).ready(function() {
      $('pre').addClass('prettyprint linenums').attr('style', 'overflow:auto;');
      prettyPrint();
  });
</script>
<!-- 代码块复制功能 -->
<script type="text/javascript" src="/js/src/clipboard.js"></script>
<script type="text/javascript" src="/js/src/clipboard-use.js"></script>
</body>
</html>
